{% extends "header10.html" %}
{% load static %}

{% block styles %}
<!-- Include Bootstrap CSS for styling -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

<!-- Include DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">

<style>
    /* Styling for sticky header */
    thead th {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: #f8f9fa;
    }

    /* Adjusting the table for better readability */
    table.dataTable {
        width: 100%;
        margin: 0 auto;
        clear: both;
    }
      /* Adjusting the table for better readability */
      .table-responsive {
        margin: 0 auto;
    }


    /* Enable horizontal scrolling */
   

    .d-flex {
        margin-top: 50px; /* adjust the value to your liking */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-success text-center">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
    
    <div class="d-flex mb-4 mt-3">
        <a class="btn btn-primary me-2" href="{% url 'deed' %}">
            <i class="fa fa-plus"></i> Add New Deed
        </a>
        
    </div>
    
    <div class="card">
        <div class="card-header text-center">My Deeds</div>
        <div class="card-body table-responsive">
            <table id="order-table" 
            class="table table-striped table-bordered dt-responsive nowrap" 
            data-show-export="true" 
            data-toggle="table"
            data-export-types="[‘png’, ‘csv’,‘doc’, ‘excel’, ‘xlsx’, ‘pdf’]">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="select-all">
                        </th>
                        <th>NSSF_No</th>
                        <th>Employer_Name</th>
                        <th>Date added</th>
                        <th>From_Date</th>
                        <th>To_Date</th>
                        <th>Branch</th>
                        <th>Deed_Source</th>
                        <th>Team_Leader</th>
                        <th>Legacy_Status</th>
                        <th>Signed_Deed</th>
                        <th>Status</th>
                        <th>Attachments</th>
                        <th></th> <!-- Column for the responsive control -->
                    </tr>
                </thead>
                <tbody>
                    {% for data in submitted_deeds %}
                    <tr>
                        <td>
                            <input type="checkbox" class="record-checkbox">
                        </td>
                        <td>
                            <a href="{% url 'deeddetail' data.id %}" class="text-primary">{{ data.nssf_no }}</a>
                        </td>
                        <td>{{ data.employer_name|truncatechars:25 }}</td>
                        <td>{{ data.date_created }}</td>
                        <td>{{ data.From_Date }}</td>
                        <td>{{ data.To_Date }}</td>
                        <td>{{ data.Branch|truncatechars:25 }}</td>
                        <td>{{ data.Deed_source|truncatechars:25 }}</td>
                        <td>{{ data.team_leader|truncatechars:25 }}</td>
                        <td>{{ data.Legacy_status|yesno:"Yes,No" }}</td>
                        <td>{{ data.Signed_Deed|yesno:"Yes,No" }}</td>
                        <td>{{ data.state }}</td>
                        <td>{% if data.attachments.all %}
                        <ul>
                        {% for attachment in data.attachments.all %}
                            <li><a href="{{ attachment.file.url }}" download>{{ attachment.file.name }}</a></li>
                        {% endfor %}
                        </ul>
                        {% endif %}
                        <td></td> <!-- Cell for the responsive control -->
                    </tr>
                    {% endfor %}
                </td>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include jQuery and DataTables JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

<script>
    $(document).ready(function() {
        // DataTable initialization
        $('#order-table').DataTable({
            "paging": true,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": true,
            "responsive": {
                details: {
                    type: 'column',
                    target: -1 // Place the toggle at the extreme end
                }
            },
            // Enable horizontal scrolling
            "columnDefs": [
                { "type": "datetime", "targets": 3 }, // Adjust column index as needed
                { "className": "control", "orderable": false, "targets": -1 } // Add control class to the last column
            ],
            "order": [[3, 'desc']] // Order by the 'From Date' column
        });

        // Select/Deselect all checkboxes
        $('#select-all').on('click', function() {
            var rows = $('#order-table').DataTable().rows({ 'search': 'applied' }).nodes();
            $('input[type="checkbox"]', rows).prop('checked', this.checked);
        });

        // Select all checkbox
        $('#select-all').on('click', function() {
            $('.record-checkbox').prop('checked', $(this).prop('checked'));
        });

        // Delete selected rows
        $('#remove').on('click', function() {
            var ids = [];
            $('.record-checkbox:checked').each(function() {
                ids.push($(this).val());
            });

            if (ids.length > 0) {
                if (confirm("Are you sure you want to delete the selected deeds?")) {
                    $.ajax({
                        type: 'POST',
                        url: '{% url "delete_deeds" %}',
                        data: {
                            'ids': ids,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(data) {
                            location.reload();
                        },
                        fail: function(xhr, status, error) {
                            console.error('Error deleting deeds:', error);
                        }
                    });  
                }
            } else {
                alert("Please select at least one deed to delete.");
            }
        });
    });
</script>
{% endblock %}
